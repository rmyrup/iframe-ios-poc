<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">

  <meta http-equiv="cache-control" content="max-age=0"/>
  <meta http-equiv="cache-control" content="no-cache"/>
  <meta http-equiv="expires" content="0"/>
  <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT"/>
  <meta http-equiv="pragma" content="no-cache"/>

  <title>iframe-ios-poc | content</title>

  <link href="css/loading.css" rel="stylesheet"/>
  <style type="text/css">
    body, html {
      margin: 0;
      padding: 0;
      font-size: 12px;
    }

    body {
      overflow: hidden;
      background-color: #e39649;
      transition: background-color 1s ease;
    }

    section {
      margin: 2em;
    }

    pre {
      padding: 1em;
      background-color: #212121;
      color: #8ae300;
    }

    #widgetWrapper {
      overflow-y: hidden;
      overflow-x: auto;
      max-width: 300px;
    }

    .theBigItem {
      width: 1500px;
      padding: 1em;
      background-color: #e30095;
      border-color: #e0e300;
      border-style: solid;
      border-width: 0 3px;
      color: #ffffff;
      text-align: center;

      display: none;
    }

    body.ready {
      background-color: #5ee35a;
    }

    body.ready .theBigItem {
      display: block;
    }
  </style>
</head>
<body class="theBody">

<div class="theLoader">
  <div id="theLoader--wrapper">
    <div id="theLoader--text">Loading</div>
    <div id="theLoader--bar">
      <div id="theLoader--bar-inner" class="theLoader--bar-inner"></div>
    </div>
  </div>
</div>

<div id="widgetWrapper">

  <section>
    <h1>iframe-ios-poc | content</h1>
  </section>

  <section>
    <pre id="theOutput"></pre>
  </section>

  <div class="theBigItem">
    <h3>The Big Item</h3>
    <p>The parent div of this text is purposely wider than what we think the iphone viewport might be.</p>
  </div>

  <section>
    <p>The magenta colored item above has a width that is definitely wider than the mobile viewport.</p>
  </section>

</div>

<script type="text/javascript">
  var theBody = document.getElementsByClassName('theBody')[0],
      widgetWrapper = document.getElementById('widgetWrapper'),
      theOutput = document.getElementById('theOutput');

  function toggleClass(className) {
    var el = theBody;

    if (!className) return false;

    if (el.classList) {
      el.classList.toggle(className);
    } else {
      var classes = el.className.split(' ');
      var existingIndex = classes.indexOf(className);

      if (existingIndex >= 0)
        classes.splice(existingIndex, 1);
      else
        classes.push(className);

      el.className = classes.join(' ');
    }
  }

  function getDocHeight() {
    var D = document;
    return Math.max(
        Math.max(D.body.scrollHeight, D.documentElement.scrollHeight),
        Math.max(D.body.offsetHeight, D.documentElement.offsetHeight),
        Math.max(D.body.clientHeight, D.documentElement.clientHeight)
    );
  }

  function debounce(func, wait, immediate) {
    var timeout;
    return function () {
      var context = this, args = arguments;
      var later = function () {
        timeout = null;
        if (!immediate) func.apply(context, args);
      };
      var callNow = immediate && !timeout;
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
      if (callNow) func.apply(context, args);
    };
  }

  function askIframeResize() {
    var theBody = document.getElementsByClassName('theBody')[0],
        bodyHeight = getDocHeight(),
        bodyDims = theBody.getBoundingClientRect();

    theOutput.textContent = "body height = " + bodyHeight + "\n";

    widgetWrapper.style.maxWidth = bodyDims.width + "px";

    window.parent.postMessage({
      'type': 'size',
      'method': 'set',
      'payload': {"width": "100%", "height": bodyHeight + "px"}
    }, '*');
  }

  var debouncedResize = debounce(function () {
    console.log('size changed');
    askIframeResize();
  }, 250);

  window.addEventListener('resize', debouncedResize);

  window.addEventListener('message', function (evt) {
    var payload = evt.data;
    if (payload.type === 'data') {
      console.log('postMessage type data');
      console.dir(payload);
    } else if (payload.type === 'dataglobal') {
      console.log('postMessage type dataglobal');
      console.dir(payload);
    } else if (payload.type == 'orientationchange') {
      console.log('postMessage type orientationchange');
      console.dir(payload);
    }
  }, false);

  // set the ready class on the body
  toggleClass('ready');

  // an initial resize
  askIframeResize();

  // offset the loaded class transition from the ready class transition
  setTimeout(function () {
    toggleClass('loaded');
  }, 1000);

</script>

</body>
</html>
